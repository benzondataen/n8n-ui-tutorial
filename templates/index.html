<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>n8n Workflow Dashboard</title>
  <style>
    /* Base Styles */
    body {
      font-family: 'Inter', sans-serif; /* ‡πÉ‡∏ä‡πâ Font Inter */
      padding: 1rem;
      margin: 0;
      background-color: #f0f2f5; /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
    }
    h1 {
      font-size: 1.8rem;
      color: #333;
      margin-bottom: 1.5rem;
      text-align: center;
    }
    .card-container {
      width: 100%;
      max-width: 500px; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
    }
    .card {
      background: #ffffff;
      border-radius: 12px; /* ‡∏°‡∏∏‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô */
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* ‡πÄ‡∏á‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•‡∏Ç‡∏∂‡πâ‡∏ô */
      margin-bottom: 1rem;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .card h2 {
      font-size: 1.4rem;
      color: #333;
      margin: 0;
      text-align: center;
      display: flex; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ H2 ‡πÄ‡∏õ‡πá‡∏ô flex container */
      align-items: center; /* ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
      justify-content: center; /* ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
      gap: 0.5rem; /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç */
    }
    .status-count {
        font-size: 0.9em; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
        color: #666; /* ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡∏•‡∏á */
        font-weight: normal; /* ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤ */
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 0.75rem; /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Control */
    }
    .controls select,
    .controls button {
      width: 100%;
      padding: 0.8rem 1rem;
      font-size: 1rem;
      border: 1px solid #ddd;
      border-radius: 8px; /* ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞ Dropdown ‡∏°‡∏µ‡∏°‡∏∏‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô */
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      box-sizing: border-box;
    }
    .controls select {
      background-color: #f8f8f8;
      color: #333;
      appearance: none; /* ‡∏•‡∏ö Arrow ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á Dropdown */
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>');
      background-repeat: no-repeat;
      background-position: right 0.8rem center;
      background-size: 1.2em;
    }
    .controls button {
      background-color: #007bff; /* ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏•‡∏±‡∏Å */
      color: #fff;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .controls button:hover:not(:disabled) {
      background-color: #0056b3; /* ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ Hover */
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .controls button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      box-shadow: none;
    }
    .loading {
      display: none;
      text-align: center;
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #555;
    }
    .result {
      margin-top: 0.75rem;
      font-size: 0.9rem;
      word-wrap: break-word;
      white-space: pre-wrap; /* ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ */
      padding: 0.75rem;
      border-radius: 6px;
      background-color: #e9ecef;
      color: #333;
      border: 1px solid #dee2e6;
    }
    .result.success {
      background-color: #d4edda;
      color: #155724;
      border-color: #c3e6cb;
    }
    .result.error {
      background-color: #f8d7da;
      color: #721c24;
      border-color: #f5c6cb;
    }
    .result.warning {
      background-color: #fff3cd;
      color: #856404;
      border-color: #ffeeba;
    }

    /* Responsive Adjustments (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô) */
    @media (min-width: 600px) {
      h1 {
        font-size: 2.2rem;
      }
      .card-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô */
        gap: 1.5rem;
        max-width: 900px;
      }
      .card {
        padding: 2rem;
      }
      .card.full-width { /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Å‡∏¥‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
        grid-column: 1 / -1;
      }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <h1>n8n Workflow Dashboard</h1>

  <div class="card-container">
    <div class="card full-width">
      <h2>‡∏™‡∏£‡πâ‡∏≤‡∏á Idea (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠)</h2>
      <div class="controls">
        <select id="category-select" disabled>
          <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠...</option>
          </select>
        <button id="btn-create-idea" data-webhook-type="create_idea" disabled>Trigger ‡∏™‡∏£‡πâ‡∏≤‡∏á Idea</button>
        <div id="loading-create_idea" class="loading">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠...</div>
      </div>
      <div id="result-create_idea" class="result"></div>
    </div>

    <div class="card">
      <h2>‡∏™‡∏£‡πâ‡∏≤‡∏á Image Prompt <span id="count-ready-prompt" class="status-count"></span></h2>
      <div class="controls">
        <button id="btn-create-image-prompt" data-webhook-type="create_image_prompt">Trigger ‡∏™‡∏£‡πâ‡∏≤‡∏á Image Prompt</button>
        <div id="loading-create_image_prompt" class="loading">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠...</div>
      </div>
      <div id="result-create_image_prompt" class="result"></div>
    </div>

    <div class="card">
      <h2>‡∏™‡∏£‡πâ‡∏≤‡∏á Image <span id="count-ready-image" class="status-count"></span></h2>
      <div class="controls">
        <button id="btn-create-image" data-webhook-type="create_image">Trigger ‡∏™‡∏£‡πâ‡∏≤‡∏á Image</button>
        <div id="loading-create_image" class="loading">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠...</div>
      </div>
      <div id="result-create_image" class="result"></div>
    </div>

    <div class="card full-width">
      <h2>‡πÇ‡∏û‡∏™‡∏ï‡πå Facebook <span id="count-ready-post" class="status-count"></span></h2>
      <div class="controls">
        <button id="btn-post-fb" data-webhook-type="post_fb">Trigger ‡πÇ‡∏û‡∏™‡∏ï‡πå Facebook</button>
        <div id="loading-post_fb" class="loading">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠...</div>
      </div>
      <div id="result-post_fb" class="result"></div>
    </div>
  </div>

  <script>
    // Map webhook types to their corresponding workflow page URLs for error linking
    const workflowPageUrls = {
      'create_idea': '{{ workflow_pages.create_idea }}',
      'create_image_prompt': '{{ workflow_pages.create_image_prompt }}',
      'create_image': '{{ workflow_pages.create_image }}',
      'post_fb': '{{ workflow_pages.post_fb }}'
    };

    const categorySelect = document.getElementById('category-select');
    const allButtons = document.querySelectorAll('button[data-webhook-type]');

    // Function to enable/disable all buttons and the dropdown
    function setButtonsDisabled(disabled) {
      allButtons.forEach(button => {
        button.disabled = disabled;
      });
      categorySelect.disabled = disabled; // Control the dropdown as well
    }

    // Function to clear all result messages
    function clearAllResults() {
      document.querySelectorAll('.result').forEach(div => {
        div.innerHTML = '';
        div.className = 'result'; // Reset class to remove status colors
      });
    }

    // Function to handle webhook triggering
    async function triggerWebhook(webhookType, payload = null) {
      // Clear previous results and show loading for the active card
      clearAllResults();
      const loadingDiv = document.getElementById(`loading-${webhookType}`);
      const resultDiv = document.getElementById(`result-${webhookType}`);

      loadingDiv.style.display = 'block';
      setButtonsDisabled(true); // Disable all buttons

      let response;
      try {
        let fetchOptions = {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        };

        if (webhookType === 'create_idea') {
          fetchOptions.method = 'POST'; // create_idea is a POST request
          fetchOptions.body = JSON.stringify(payload);
        }

        response = await fetch(`/trigger/${webhookType}`, fetchOptions);
        const data = await response.json(); // Always try to parse JSON

        loadingDiv.style.display = 'none';
        setButtonsDisabled(false); // Enable all buttons

        if (response.ok) {
          resultDiv.textContent = `‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${response.status}.`;
          resultDiv.classList.add('success');
        } else {
          // Create a link to the workflow page for error cases
          const workflowPageUrl = workflowPageUrls[webhookType] || '#';
          resultDiv.innerHTML = `‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß! ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${response.status}. ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${data.error || JSON.stringify(data)}<br><a href="${workflowPageUrl}" target="_blank">‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤ Workflow</a>`;
          resultDiv.classList.add('error');
        }
      } catch (error) {
        loadingDiv.style.display = 'none';
        setButtonsDisabled(false); // Enable all buttons
        const workflowPageUrl = workflowPageUrls[webhookType] || '#';
        resultDiv.innerHTML = `‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ${error.message}<br><a href="${workflowPageUrl}" target="_blank">‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤ Workflow</a>`;
        resultDiv.classList.add('warning');
        console.error("Fetch Error:", error);
      } finally {
        // Always refresh status counts after a webhook trigger attempt
        fetchStatusCounts();
      }
    }

    // Event Listeners for all webhook buttons
    allButtons.forEach(button => {
      button.addEventListener('click', () => {
        const webhookType = button.dataset.webhookType;
        if (webhookType === 'create_idea') {
          const selectedCategory = categorySelect.value;
          if (!selectedCategory) {
            const resultDiv = document.getElementById(`result-${webhookType}`);
            resultDiv.innerHTML = '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ‡∏Å‡πà‡∏≠‡∏ô';
            resultDiv.classList.add('warning');
            return;
          }
          triggerWebhook(webhookType, { category: selectedCategory }); // Send payload for create_idea
        } else {
          triggerWebhook(webhookType); // No payload for other webhooks
        }
      });
    });

    // Function to fetch categories and populate the dropdown when the page loads
    async function fetchCategories() {
      try {
        const response = await fetch('/get_categories'); // Call Flask API Endpoint
        if (response.ok) {
          const data = await response.json();
          categorySelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ --</option>'; // Reset dropdown
          if (data.categories && data.categories.length > 0) {
            data.categories.forEach(category => {
              const option = document.createElement('option');
              option.value = category;
              option.textContent = category;
              categorySelect.appendChild(option);
            });
            categorySelect.disabled = false; // Enable dropdown
            document.getElementById('btn-create-idea').disabled = false; // Enable Trigger Idea button
          } else {
            categorySelect.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</option>';
          }
        } else {
          categorySelect.innerHTML = '<option value="">‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>';
          console.error('Failed to fetch categories:', response.status);
        }
      } catch (error) {
        categorySelect.innerHTML = '<option value="">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</option>';
        console.error('Error fetching categories:', error);
      }
    }

    // NEW: Function to fetch status counts and update the UI
    async function fetchStatusCounts() {
      try {
        const response = await fetch('/get_status_counts'); // Call Flask API Endpoint
        if (response.ok) {
          const data = await response.json();
          const counts = data.status_counts;
          document.getElementById('count-ready-prompt').textContent = `(${counts.ready_prompt || 0})`;
          document.getElementById('count-ready-image').textContent = `(${counts.ready_image || 0})`;
          document.getElementById('count-ready-post').textContent = `(${counts.ready_post || 0})`;
        } else {
          console.error('Failed to fetch status counts:', response.status);
          // Optionally display an error message for counts
        }
      } catch (error) {
        console.error('Error fetching status counts:', error);
        // Optionally display an error message for counts
      }
    }

    // Call initial data fetches when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', () => {
      fetchCategories(); // Fetch categories for the dropdown
      fetchStatusCounts(); // Fetch status counts for the buttons
    });
  </script>
</body>
</html>